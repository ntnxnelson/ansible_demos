---
- name: VM CRUD playbook example
  hosts: localhost
  gather_facts: false
  module_defaults:
    group/nutanix.ncp.ntnx:
      nutanix_host: "{{ pc_ip }}"
      nutanix_username: "{{ pc_user }}"
      nutanix_password: "{{ pc_password }}"
      validate_certs: false
  tasks:
    - name: Setting Variables
      ansible.builtin.set_fact:
        vm_name: "wintest-001"
        cluster:
          uuid: "0006261e-1512-d0ff-3f5b-ac1f6b3d7d4b"
        storage_container:
          uuid: "<container_extid>"
        disk_image:
          image_ext_ids:
            - "c93548f6-8a76-4b28-ab4a-25a1e722768c"
            - "ec5852e0-453a-4284-84ec-cbc0e23dbf2b"
        network:
          dhcp:
            uuid: "fbc224bf-a881-42af-8227-2e9d8224ea7c"
        xml_file_content: "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHVuYXR0ZW5kIHhtbG5zPSJ1cm46c2NoZW1hcy1taWNyb3NvZnQtY29tOnVuYXR0ZW5kIj4KICAgPHNldHRpbmdzIHBhc3M9InNwZWNpYWxpemUiPgogICAgICA8Y29tcG9uZW50IHhtbG5zOndjbT0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS9XTUlDb25maWcvMjAwMi9TdGF0ZSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgbmFtZT0iTWljcm9zb2Z0LVdpbmRvd3MtU2hlbGwtU2V0dXAiIHByb2Nlc3NvckFyY2hpdGVjdHVyZT0iYW1kNjQiIHB1YmxpY0tleVRva2VuPSIzMWJmMzg1NmFkMzY0ZTM1IiBsYW5ndWFnZT0ibmV1dHJhbCIgdmVyc2lvblNjb3BlPSJub25TeFMiPgogICAgICAgICA8Q29tcHV0ZXJOYW1lPndpbnRlc3QtMDAxPC9Db21wdXRlck5hbWU+CiAgICAgICAgIDxSZWdpc3RlcmVkT3JnYW5pemF0aW9uPk51dGFuaXg8L1JlZ2lzdGVyZWRPcmdhbml6YXRpb24+CiAgICAgICAgIDxSZWdpc3RlcmVkT3duZXI+QWNyb3BvbGlzPC9SZWdpc3RlcmVkT3duZXI+CiAgICAgICAgIDxUaW1lWm9uZT5VVEM8L1RpbWVab25lPgogICAgICA8L2NvbXBvbmVudD4KICAgICAgPGNvbXBvbmVudCB4bWxucz0iIiBuYW1lPSJNaWNyb3NvZnQtV2luZG93cy1UZXJtaW5hbFNlcnZpY2VzLUxvY2FsU2Vzc2lvbk1hbmFnZXIiIHB1YmxpY0tleVRva2VuPSIzMWJmMzg1NmFkMzY0ZTM1IiBsYW5ndWFnZT0ibmV1dHJhbCIgdmVyc2lvblNjb3BlPSJub25TeFMiIHByb2Nlc3NvckFyY2hpdGVjdHVyZT0iYW1kNjQiPgogICAgICAgICA8ZkRlbnlUU0Nvbm5lY3Rpb25zPmZhbHNlPC9mRGVueVRTQ29ubmVjdGlvbnM+CiAgICAgIDwvY29tcG9uZW50PgogICAgICA8Y29tcG9uZW50IHhtbG5zPSIiIG5hbWU9Ik1pY3Jvc29mdC1XaW5kb3dzLVRlcm1pbmFsU2VydmljZXMtUkRQLVdpblN0YXRpb25FeHRlbnNpb25zIiBwdWJsaWNLZXlUb2tlbj0iMzFiZjM4NTZhZDM2NGUzNSIgbGFuZ3VhZ2U9Im5ldXRyYWwiIHZlcnNpb25TY29wZT0ibm9uU3hTIiBwcm9jZXNzb3JBcmNoaXRlY3R1cmU9ImFtZDY0Ij4KICAgICAgICAgPFVzZXJBdXRoZW50aWNhdGlvbj4wPC9Vc2VyQXV0aGVudGljYXRpb24+CiAgICAgIDwvY29tcG9uZW50PgogICAgICA8Y29tcG9uZW50IHhtbG5zOndjbT0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS9XTUlDb25maWcvMjAwMi9TdGF0ZSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgbmFtZT0iTmV0d29ya2luZy1NUFNTVkMtU3ZjIiBwcm9jZXNzb3JBcmNoaXRlY3R1cmU9ImFtZDY0IiBwdWJsaWNLZXlUb2tlbj0iMzFiZjM4NTZhZDM2NGUzNSIgbGFuZ3VhZ2U9Im5ldXRyYWwiIHZlcnNpb25TY29wZT0ibm9uU3hTIj4KICAgICAgICAgPEZpcmV3YWxsR3JvdXBzPgogICAgICAgICAgICA8RmlyZXdhbGxHcm91cCB3Y206YWN0aW9uPSJhZGQiIHdjbTprZXlWYWx1ZT0iUmVtb3RlRGVza3RvcCI+CiAgICAgICAgICAgICAgIDxBY3RpdmU+dHJ1ZTwvQWN0aXZlPgogICAgICAgICAgICAgICA8UHJvZmlsZT5hbGw8L1Byb2ZpbGU+CiAgICAgICAgICAgICAgIDxHcm91cD5ARmlyZXdhbGxBUEkuZGxsLC0yODc1MjwvR3JvdXA+CiAgICAgICAgICAgIDwvRmlyZXdhbGxHcm91cD4KICAgICAgICAgPC9GaXJld2FsbEdyb3Vwcz4KICAgICAgPC9jb21wb25lbnQ+CiAgIDwvc2V0dGluZ3M+CiAgIDxzZXR0aW5ncyBwYXNzPSJvb2JlU3lzdGVtIj4KICAgICAgPGNvbXBvbmVudCB4bWxuczp3Y209Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vV01JQ29uZmlnLzIwMDIvU3RhdGUiIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiIG5hbWU9Ik1pY3Jvc29mdC1XaW5kb3dzLVNoZWxsLVNldHVwIiBwcm9jZXNzb3JBcmNoaXRlY3R1cmU9ImFtZDY0IiBwdWJsaWNLZXlUb2tlbj0iMzFiZjM4NTZhZDM2NGUzNSIgbGFuZ3VhZ2U9Im5ldXRyYWwiIHZlcnNpb25TY29wZT0ibm9uU3hTIj4KICAgICAgICAgPFVzZXJBY2NvdW50cz4KICAgICAgICAgICAgPExvY2FsQWNjb3VudHM+CiAgICAJCQk8TG9jYWxBY2NvdW50IHdjbTphY3Rpb249ImFkZCI+CiAgICAgICAgCQkJPE5hbWU+TnV0YW5peDwvTmFtZT4KICAgICAgICAgICAgCQkJPFBhc3N3b3JkPgogICAgICAgICAgICAgICAgCQkJPFZhbHVlPk51dGFuaXgxMjMhPC9WYWx1ZT4KICAgICAgICAgICAgICAgIAkJCTxQbGFpblRleHQ+dHJ1ZTwvUGxhaW5UZXh0PgogICAgICAgICAgIAkJCQk8L1Bhc3N3b3JkPgogICAgICAgICAgICAJCQk8R3JvdXA+QWRtaW5pc3RyYXRvcnM8L0dyb3VwPgogICAgCQkJPC9Mb2NhbEFjY291bnQ+CgkJCTwvTG9jYWxBY2NvdW50cz4KICAgICAgICAgICAgPEFkbWluaXN0cmF0b3JQYXNzd29yZD4KICAgICAgICAgICAgICAgPFZhbHVlPk51dGFuaXgxMjMhPC9WYWx1ZT4KICAgICAgICAgICAgICAgPFBsYWluVGV4dD50cnVlPC9QbGFpblRleHQ+CiAgICAgICAgICAgIDwvQWRtaW5pc3RyYXRvclBhc3N3b3JkPgogICAgICAgICA8L1VzZXJBY2NvdW50cz4KICAgICAgICAgPEF1dG9Mb2dvbj4KICAgICAgICAgICAgPFBhc3N3b3JkPgogICAgICAgICAgICAgICA8VmFsdWU+TnV0YW5peDEyMyE8L1ZhbHVlPgogICAgICAgICAgICAgICA8UGxhaW5UZXh0PnRydWU8L1BsYWluVGV4dD4KICAgICAgICAgICAgPC9QYXNzd29yZD4KICAgICAgICAgICAgPEVuYWJsZWQ+dHJ1ZTwvRW5hYmxlZD4KICAgICAgICAgICAgPFVzZXJuYW1lPk51dGFuaXg8L1VzZXJuYW1lPgogICAgICAgICAgICA8TG9nb25Db3VudD4xPC9Mb2dvbkNvdW50PgogICAgICAgICA8L0F1dG9Mb2dvbj4KICAgICAgICAgPEZpcnN0TG9nb25Db21tYW5kcz4KICAgICAgICAgICAgPFN5bmNocm9ub3VzQ29tbWFuZCB3Y206YWN0aW9uPSJhZGQiPgogICAgICAgICAgICAgICA8Q29tbWFuZExpbmU+Y21kLmV4ZSAvYyBuZXRzaCBhZHZmaXJld2FsbCBzZXQgYWxscHJvZmlsZXMgc3RhdGUgb2ZmPC9Db21tYW5kTGluZT4KICAgICAgICAgICAgICAgPERlc2NyaXB0aW9uPldpbiBSTSBwb3J0IG9wZW48L0Rlc2NyaXB0aW9uPgogICAgICAgICAgICAgICA8T3JkZXI+MTwvT3JkZXI+CiAgICAgICAgICAgICAgIDxSZXF1aXJlc1VzZXJJbnB1dD50cnVlPC9SZXF1aXJlc1VzZXJJbnB1dD4KICAgICAgICAgICAgPC9TeW5jaHJvbm91c0NvbW1hbmQ+CiAgICAgICAgICAgIDxTeW5jaHJvbm91c0NvbW1hbmQgd2NtOmFjdGlvbj0iYWRkIj4KICAgICAgICAgICAgICAgPENvbW1hbmRMaW5lPnBvd2Vyc2hlbGwgLUNvbW1hbmQgIkVuYWJsZS1QU1JlbW90aW5nIC1Ta2lwTmV0d29ya1Byb2ZpbGVDaGVjayAtRm9yY2UiPC9Db21tYW5kTGluZT4KICAgICAgICAgICAgICAgPERlc2NyaXB0aW9uPkVuYWJsZSBQUy1SZW1vdGluZzwvRGVzY3JpcHRpb24+CiAgICAgICAgICAgICAgIDxPcmRlcj4yPC9PcmRlcj4KICAgICAgICAgICAgICAgPFJlcXVpcmVzVXNlcklucHV0PnRydWU8L1JlcXVpcmVzVXNlcklucHV0PgogICAgICAgICAgICA8L1N5bmNocm9ub3VzQ29tbWFuZD4KICAgICAgICAgICAgPFN5bmNocm9ub3VzQ29tbWFuZCB3Y206YWN0aW9uPSJhZGQiPgogICAgICAgICAgICAgICA8Q29tbWFuZExpbmU+cG93ZXJzaGVsbCAtQ29tbWFuZCAiU2V0LUV4ZWN1dGlvblBvbGljeSAtRXhlY3V0aW9uUG9saWN5IFJlbW90ZVNpZ25lZCI8L0NvbW1hbmRMaW5lPgogICAgICAgICAgICAgICA8RGVzY3JpcHRpb24+RW5hYmxlIFJlbW90ZS1TaWduaW5nPC9EZXNjcmlwdGlvbj4KICAgICAgICAgICAgICAgPE9yZGVyPjM8L09yZGVyPgogICAgICAgICAgICAgICA8UmVxdWlyZXNVc2VySW5wdXQ+ZmFsc2U8L1JlcXVpcmVzVXNlcklucHV0PgogICAgICAgICAgICA8L1N5bmNocm9ub3VzQ29tbWFuZD4KICAgICAgICAgICAgPFN5bmNocm9ub3VzQ29tbWFuZCB3Y206YWN0aW9uPSJhZGQiPgogICAgICAgICAgICAgICA8Q29tbWFuZExpbmU+cG93ZXJzaGVsbCAtQ29tbWFuZCAid2lucm0gcXVpY2tjb25maWcgLUZvcmNlIjwvQ29tbWFuZExpbmU+CiAgICAgICAgICAgICAgIDxEZXNjcmlwdGlvbj5zZXR1cCB3aW5ybTwvRGVzY3JpcHRpb24+CiAgICAgICAgICAgICAgIDxPcmRlcj40PC9PcmRlcj4KICAgICAgICAgICAgICAgPFJlcXVpcmVzVXNlcklucHV0PmZhbHNlPC9SZXF1aXJlc1VzZXJJbnB1dD4KICAgICAgICAgICAgPC9TeW5jaHJvbm91c0NvbW1hbmQ+CiAgICAgICAgICAgIDxTeW5jaHJvbm91c0NvbW1hbmQgd2NtOmFjdGlvbj0iYWRkIj4KICAgICAgICAgICAgICAgPENvbW1hbmRMaW5lPnBvd2Vyc2hlbGwgLUNvbW1hbmQgIlNldC1JdGVtIHdzbWFuOlxcbG9jYWxob3N0XFxjbGllbnRcXHRydXN0ZWRob3N0cyAqIC1Gb3JjZSI8L0NvbW1hbmRMaW5lPgogICAgICAgICAgICAgICA8RGVzY3JpcHRpb24+YWxsb3cgdHJ1c3RlZCBob3N0czwvRGVzY3JpcHRpb24+CiAgICAgICAgICAgICAgIDxPcmRlcj41PC9PcmRlcj4KICAgICAgICAgICAgICAgPFJlcXVpcmVzVXNlcklucHV0PmZhbHNlPC9SZXF1aXJlc1VzZXJJbnB1dD4KICAgICAgICAgICAgPC9TeW5jaHJvbm91c0NvbW1hbmQ+CiAgICAgICAgICAgIDxTeW5jaHJvbm91c0NvbW1hbmQgd2NtOmFjdGlvbj0iYWRkIj4KICAgICAgICAgICAgICAgPENvbW1hbmRMaW5lPnBvd2Vyc2hlbGwgLUNvbW1hbmQgIlJlc3RhcnQtU2VydmljZSBXaW5STSI8L0NvbW1hbmRMaW5lPgogICAgICAgICAgICAgICA8RGVzY3JpcHRpb24+cmVzdGFydCB3aW5STTwvRGVzY3JpcHRpb24+CiAgICAgICAgICAgICAgIDxPcmRlcj42PC9PcmRlcj4KICAgICAgICAgICAgICAgPFJlcXVpcmVzVXNlcklucHV0PmZhbHNlPC9SZXF1aXJlc1VzZXJJbnB1dD4KICAgICAgICAgICAgPC9TeW5jaHJvbm91c0NvbW1hbmQ+CiAgICAgICAgIDwvRmlyc3RMb2dvbkNvbW1hbmRzPgogICAgICAgICA8T09CRT4KICAgICAgICAgICAgPEhpZGVFVUxBUGFnZT50cnVlPC9IaWRlRVVMQVBhZ2U+CiAgICAgICAgICAgIDxTa2lwTWFjaGluZU9PQkU+dHJ1ZTwvU2tpcE1hY2hpbmVPT0JFPgogICAgICAgICA8L09PQkU+CiAgICAgIDwvY29tcG9uZW50PgogICAgICA8Y29tcG9uZW50IHhtbG5zOndjbT0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS9XTUlDb25maWcvMjAwMi9TdGF0ZSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSIgbmFtZT0iTWljcm9zb2Z0LVdpbmRvd3MtSW50ZXJuYXRpb25hbC1Db3JlIiBwcm9jZXNzb3JBcmNoaXRlY3R1cmU9ImFtZDY0IiBwdWJsaWNLZXlUb2tlbj0iMzFiZjM4NTZhZDM2NGUzNSIgbGFuZ3VhZ2U9Im5ldXRyYWwiIHZlcnNpb25TY29wZT0ibm9uU3hTIj4KICAgICAgICAgPElucHV0TG9jYWxlPmVuLVVTPC9JbnB1dExvY2FsZT4KICAgICAgICAgPFN5c3RlbUxvY2FsZT5lbi1VUzwvU3lzdGVtTG9jYWxlPgogICAgICAgICA8VUlMYW5ndWFnZUZhbGxiYWNrPmVuLXVzPC9VSUxhbmd1YWdlRmFsbGJhY2s+CiAgICAgICAgIDxVSUxhbmd1YWdlPmVuLVVTPC9VSUxhbmd1YWdlPgogICAgICAgICA8VXNlckxvY2FsZT5lbi1VUzwvVXNlckxvY2FsZT4KICAgICAgPC9jb21wb25lbnQ+CiAgIDwvc2V0dGluZ3M+CjwvdW5hdHRlbmQ+Cg=="
        cloud_init_script: "I2Nsb3VkLWNvbmZpZwp1c2VyczoKICAtIG5hbWU6IGJ1aWxkZXIKICAgIHN1ZG86IFsnQUxMPShBTEwpIE5PUEFTU1dEOkFMTCddCmNocGFzc3dkOgogIGxpc3Q6IHwKICAgIGJ1aWxkZXI6cGFja2VyCiAgZXhwaXJlOiBGYWxzZQpzc2hfcHdhdXRoOiBUcnVlCg=="


    - name: Create VM configured for UEFI boot
      nutanix.ncp.ntnx_vms_v2:
        name: "{{ vm_name }}"
        description: ansible test
        cluster:
          ext_id: "{{ cluster.uuid }}"
        boot_config:
          uefi_boot:
            is_secure_boot_enabled: false
        disks:
          - backing_info:
              vm_disk:
                disk_size_bytes: 161061273600 # 150GB
                data_source:
                  reference:
                    image_reference:
                      image_ext_id: "{{ disk_image.image_ext_ids[1] }}"
            disk_address:
              bus_type: SCSI
              index: 0
        nics:
          - network_info:
              subnet:
                ext_id: "{{ network.dhcp.uuid }}"
        guest_customization:
          config:
            sysprep:
              install_type: "FRESH"
              sysprep_script:
                unattendxml:
                  value: "{{ xml_file_content }}"
      register: result
      ignore_errors: true